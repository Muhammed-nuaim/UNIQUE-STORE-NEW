<%- include('../layouts/user/header.ejs') %>

    <div class="container py-4">
        <!-- Breadcrumb -->
        <div class="container">
            <div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
                <a href="/" class="stext-109 cl8 hov-cl1 trans-04">
                    Home
                    <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
                </a>
                <a href="/cartPage" class="stext-109 cl8 hov-cl1 trans-04">
                    Carp Page
                    <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
                </a>
    
                <span class="stext-109 cl4">
                    Checkout Page
                </span>
            </div>
        </div>

        <div class="row g-4">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Product Section -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="wrap-table-shopping-cart">
                        <table class="table-shopping-cart">
                            <tr class="table_head">
                                <th class="column-1">Image</th>
                                <th class="column-2">Product Name</th>
                                <th class="column-3">Price</th>
                                <th class="column-4">Quantity</th>
                                <th class="column-5">Total</th>
                            </tr>
                            <% for ( i = 0 ; i < cartData.length ; i++) {%>
                                <tr class="table_row">
                                    <td class="column-1">
                                        <div class="how-itemcart1">
                                            <img src="/uploads/re-image/<%= cartData[i].productId.productImage[0] %>" alt="IMG">
                                        </div>
                                    </td>
                                    <td class="column-2"><%= cartData[i].productId.productName %></td>
                                    <td class="column-3">₹<%= cartData[i].price %></td>
                                    <td class="column-4"><%= cartData[i].Quantity %></td>
                                    <td class="column-5">₹<%= cartData[i].totalPrice %></td>
                                </tr>
                            <% } %>
                        </table>
                    </div>
                    </div>
                </div>

                <!-- Address Section -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">Select Delivery Address</h5>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-outline w-full" id="addNewAddressBtn">Add New Address +</button>
                          </div>
                              <!-- Modal for Address Form -->
                        <div id="addressModal" class="fixed inset-0 overflow-y-auto h-full w-full" style="display: none;">
                            <div class="relative top-20 mx-auto border border-black w-75 shadow-lg rounded-md bg-white">
                            <div class="mt-3 text-center">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">Add New Address</h3>
                                <form id="addressForm" class="mt-2 text-left" method="post" action="/addAddress">
                                <input type="hidden" id="addressId" name="addressId">
                                <div class="mb-2">
                                    <label for="addressType" class="block text-sm font-medium text-black">Address Type</label>
                                    <select id="addressType" name="addressType" class="mt-1 block w-full py-2 px-3 border-black bg-white rounded-md shadow-sm">
                                    <option value="Home">Home</option>
                                    <option value="WorkSpace">WorkSpace</option>
                                    <option value="Shop">Shop</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label for="name" class="block text-sm font-medium text-black">Name</label>
                                    <input type="text" id="name" name="name"  class="mt-1 focus:ring-indigo-500 py-2 block w-full shadow-sm sm:text-sm border-black rounded-md">
                                    <div id="error1" class="error-message"></div>
                                </div>
                                <div class="mb-2">
                                    <label for="city" class="block text-sm font-medium text-black">City</label>
                                    <input type="text" id="city" name="city"  class="mt-1 focus:ring-indigo-500 py-2 block w-full shadow-sm sm:text-sm border-black rounded-md">
                                    <div id="error2" class="error-message"></div>
                                </div>
                                <div class="mb-2">
                                    <label for="landMark" class="block text-sm font-medium text-black">Landmark</label>
                                    <input type="text" id="landMark" name="landMark"  class="mt-1 focus:ring-indigo-500 py-2 block w-full shadow-sm sm:text-sm border-black rounded-md">
                                    <div id="error3" class="error-message"></div>
                                </div>
                                <div class="mb-2">
                                    <label for="state" class="block text-sm font-medium text-black">State</label>
                                    <input type="text" id="state" name="state"  class="mt-1 focus:ring-indigo-500 py-2 block w-full shadow-sm sm:text-sm border-black rounded-md">
                                    <div id="error4" class="error-message"></div>
                                </div>
                                <div class="mb-2">
                                    <label for="pincode" class="block text-sm font-medium text-black">Pincode</label>
                                    <input type="text" id="pincode" name="pincode"  class="mt-1 focus:ring-indigo-500 py-2 block w-full shadow-sm sm:text-sm border-black rounded-md">
                                    <div id="error5" class="error-message"></div>
                                </div>
                                <div class="mb-2">
                                    <label for="phone" class="block text-sm font-medium text-black">Phone</label>
                                    <input type="tel" id="phone" name="phone"  class="mt-1 focus:ring-indigo-500 py-2 block w-full shadow-sm sm:text-sm border-black rounded-md">
                                    <div id="error6" class="error-message"></div>
                                </div>
                                <div class="mb-2">
                                    <label for="altPhone" class="block text-sm font-medium text-black">Alternative Phone (optional)</label>
                                    <input type="tel" id="altPhone" name="altPhone"  class="mt-1 block w-full py-2 sm:text-sm border-black rounded-md">
                                    <div id="error7" class="error-message"></div>
                                </div>
                                <div class="flex justify-end mt-4">
                                    <button type="button" id="cancelAddress" class="mr-2 px-4 py-2 bg-white text-sm text-black border-black rounded">Cancel</button>
                                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-sm text-black border-black rounded">Save</button>
                                </div>
                                </form>
                            </div>
                            </div>
                        </div>
                        <div class="border rounded p-3 mb-3">
                            <div class="form-check">
                                <div class="card-content">
                                    <% for(let i=0 ; i<addressData.length ; i++) { %>
                                    <div class="space-y-4">
                                    <div class="border rounded p-4">
                                        <div class="flex justify-between items-start">
                                    <input class="form-check-input" type="radio" name="address" id="<%=addressData[i]._id %>" checked>
                                    <label class="form-check-label" for="<%=addressData[i]._id %>">
                                        <div>
                                            <p class="font-semibold"><%= addressData[i].addressType %></p>
                                            <p class="text-sm text-muted-foreground"><%= addressData[i].landMark %>, <%= addressData[i].city %>, <%= addressData[i].state %>,<%= addressData[i].pincode %></p>
                                        </div>
                                    </label>
                                        </div>
                                    </div>
                                    </div>
                                    <% } %>
                                </div>      
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Payment Section -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Payment Method</h5>
                        <p class="text-muted small mb-4">Select any payment method</p>

                        <div class="border rounded p-3 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment" id="PayPal" checked>
                                <label class="form-check-label" for="PayPal">PayPal</label>
                            </div>
                        </div>

                        <div class="border rounded p-3 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment" id="Cash on Delivery">
                                <label class="form-check-label" for="Cash on Delivery">Cash on Delivery</label>
                            </div>
                        </div>

                        <div class="border rounded p-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="payment" id="Wallet">
                                <label class="form-check-label" for="Wallet">Wallet</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Cart Summary -->
            <div class="col-lg-4">
                <% if(existingCoupon.length > 0 ) { %>
                <% if (couponApply === false ) { %>
                <!-- Availabe Coupons -->
                <div class="card ">
                    <div class="card-header">
                        <h5 class="card-title mb-0 text-success">Available Coupons</h5>
                    </div>
                            <div class="card-body">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Code</th>
                                            <th>Limit</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% for (let i = 0; i < existingCoupon.length; i++) { %>
                                            <tr>
                                                <td><%= existingCoupon[i].name %></td>
                                                <td><%= existingCoupon[i].code %></td>
                                                <% for ( let j = 0 ; j < existingCoupon[i].usage.length ; j++) {%>
                                                <% if (existingCoupon[i].usage[j].userId._id == user.id) {%>
                                                    <td><%= existingCoupon[i].usage[j].usageLimit %> / <%= existingCoupon[i].usageLimit %></td>
                                                <% } else { %>
                                                    <td><%= 0/existingCoupon[i].usageLimit %></td>
                                                <% } %>
                                                <% } %>
                                                <td>
                                                    <button class="btn btn-sm btn-success" onclick="applyCoupon('<%= existingCoupon[i].code%>','<%=cart.subTotal%>')">
                                                        Apply
                                                    </button>
                                                </td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    <% } else { %>
                        <!-- Applied Coupon -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Appied Coupon</h5>
                            </div>
                            <div class="card-body">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Discount%</th>
                                            <th>Saved</th>
                                            <th>Limit</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><span class="text-success"><%= existingCouponUser.discountPrice  %></span></td>
                                            <td><span class="text-success"><%= couponApply.discountPrice %></span></td>
                                            <% for ( let j = 0 ; j < existingCouponUser.usage.length ; j++) {%>
                                            <% if (existingCouponUser.code == couponApply.code && existingCouponUser.usage[j].userId._id == user.id) {%>
                                            <td class="text-success"><%= existingCouponUser.usage[j].usageLimit %> / <%= existingCouponUser.usageLimit %></td>
                                            <% } %>
                                            <% } %>
                                            <td>
                                                <button class="btn btn-sm btn-danger"  onclick="cancellCoupon('<%=couponApply.code %>','<%=cart.subTotal%>')">
                                                    Cancel
                                                </button>
                                            </td>
                                        </tr>
                                    <tbody>
                                </table>
                            </div>
                        </div>     
                    <% } %>
                    <% } %>
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Cart Total</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <span>items(<%= cartData.length %>)</span>
                                <span>₹<%=cart.subTotal %></span>
                            </div>
                            <% if (couponApply !== false ) { %>
                            <div class="d-flex justify-content-between mb-3 text-success">
                                <span>Discount For Coupon </span>
                                <span><%= couponApply.discountPrice %></span>
                            </div>
                            <% } %>
                            <% if (deliveryCharge!=0) { %>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Delivery Charge </span>
                                <span>₹<%= deliveryCharge %></span>
                            </div>
                            <% } else { %>
                                <div class="d-flex justify-content-between mb-3 text-success">
                                    <span>Delivery Charge </span>
                                    <span>Free</span>
                                </div>
                            <% } %>
                            <hr>
                            <div class="d-flex justify-content-between mb-4">
                                <strong>TOTAL</strong>
                                <strong>₹<%=cart.subTotal+deliveryCharge %></strong>
                            </div>
                            <button id="confirmOrderBtn" class="btn btn-dark w-100 mb-3">CONFIRM TO ORDER</button>
                            <% if (couponApply === false ) { %>
                            <form method="post" id="coupnForm" onsubmit="return handleFormSubmit(event)">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Enter your Coupon code" id="couponCode">
                                    <button class="btn btn-success ml-3" type="submit">Apply</button>
                                </div>
                            </form>
                            
                            <% } else { %>
                                <button class="btn btn-danger" type="button" onclick="cancellCoupon('<%=couponApply.code %>','<%=cart.subTotal%>')">Cancel The Applied Coupon</button></a>
                            <% } %> 
                        </div>
                    </div>
                </div>
            </div>  
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
  .error-message { color: red; font-size: 0.75rem; display: none; }

           #addressModal {
    border: 1px solid black; 
  }

  #addressForm input, 
  #addressForm select {
    border: 1px solid black; 
    border-radius: 0.375rem; 
  }

  #addressForm button {
    border: 1px solid black;
  }
  @media (min-width: 768px) {
    .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  
  @media (min-width: 1024px) {
    .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
  }
    </style>
    <%- include('../layouts/user/footer.ejs') %>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        
    document.addEventListener("DOMContentLoaded", function() {
    const confirmOrderBtn = document.getElementById("confirmOrderBtn");
    
        
    const addNewAddressBtn = document.getElementById("addNewAddressBtn");
    const addressModal = document.getElementById("addressModal");
    const cancelAddressBtn = document.getElementById("cancelAddress");

    addNewAddressBtn.addEventListener('click', function () {
      addressModal.style.display = 'block';
    });

    cancelAddressBtn.addEventListener('click', function () {
      addressModal.style.display = 'none';
    });

    window.addEventListener('click', function (e) {
      if (e.target == addressModal) {
        addressModal.style.display = 'none'; 
      }
    });

    confirmOrderBtn.addEventListener("click", function () {
        const selectedAddress = document.querySelector('input[name="address"]:checked')?.id;
        const selectedPaymentMethod = document.querySelector('input[name="payment"]:checked')?.id;

        if (!selectedAddress || !selectedPaymentMethod) {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Please select both an address and a payment method.",
            })
            return;
        }
        

        if (selectedPaymentMethod === "PayPal") {
            fetch('/payPal', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subTotal: '<%= cart.subTotal+deliveryCharge %>',
                    addressId: selectedAddress,
                    paymentMethod: selectedPaymentMethod,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.approval_url) {
                    window.location.href = data.approval_url;
                } else {
                    Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: "Error initiating PayPal payment. Please try again.",
                })
                }
            })
            .catch(error => console.error('Error:', error));
        } else if (selectedPaymentMethod === "Wallet") {
            $.ajax({
                url: '/paymentThroughWallet',
                method: 'POST',
                data: JSON.stringify({
                    subTotal: '<%= cart.subTotal+deliveryCharge %>',
                    addressId: selectedAddress,
                    paymentMethod: selectedPaymentMethod,
                }),
                contentType: "application/json",
                success: function(res) {
                    if (res.success) {
                        window.location.href = "/order/success";
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: res.message,
                        }).then(() => {
                            location.reload();
                        });
                    }
                },
                error: function(xhr, status, error) {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "Failed to complete payment through Wallet. Please try again.",
                    });
                    console.error("AJAX Error:", status, error, xhr.responseText);
                }
            });
            
        } else {
            const orderData = {
                addressId: selectedAddress,
                paymentMethod: selectedPaymentMethod,
            };

            fetch('/order/success', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "/order-success";
                } else if (data.success == false) {
                    Swal.fire({
                        icon: "warning",
                        title: "!Oops",
                        text: data.message,
                    }).then(() => {
                        location.reload();
                    })
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
});



        function handleFormSubmit(event) {
        event.preventDefault();

        const couponCode = document.getElementById("couponCode").value.trim();
        applyCoupon(couponCode, "<%= cart.subTotal %>");
        return false;
    }

    function applyCoupon(couponCode, subTotal) {
        $.ajax({
            url: "/applyCoupon",
            type: "POST",
            data: JSON.stringify({
                couponCode: couponCode,
                subTotal: subTotal
            }),
            contentType: "application/json", 
            success: function(res) {
                if (res.success) {
                    Swal.fire({
                        icon: "success",
                        title: "Success",
                        text: res.message,
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: "warning",
                        title: "!Oops",
                        text: res.message,
                    });
                }
            },
            error: function(error) {
                Swal.fire({
                    icon: "error",
                    title: "Server Error",
                    text: "A server error has occurred."
                }).then(() => {
                    window.location.href = "/login";
                });
            }
        });
    }

    function cancellCoupon( couponDetails ,subTotal ) {
        $.ajax({
            url: "/cancellCoupon",
            type: "POST",
            data: JSON.stringify({
                couponCode: couponDetails,
                subTotal: subTotal
            }),
            contentType: "application/json",
            success: function(res) {
                if (res.success) {
                    Swal.fire({
                        icon: "success",
                        title: "Success",
                        text: res.message,
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: "warning",
                        title: "!Oops",
                        text: res.message,
                    });
                }
            },
            error: function(error) {
                Swal.fire({
                    icon: "error",
                    title: "Server Error",
                    text: "A server error has occurred."
                }).then(() => {
                    window.location.href = "/login";
                });
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
    const addNewAddressBtn = document.getElementById("addNewAddressBtn");
    const addressModal = document.getElementById("addressModal");
    const cancelAddressBtn = document.getElementById("cancelAddress");
    const form = document.getElementById("addressForm");

    addNewAddressBtn.addEventListener('click', () => {
        addressModal.style.display = 'block';
    });

    cancelAddressBtn.addEventListener('click', () => {
        addressModal.style.display = 'none';
        clearErrors();
        form.reset();
    });

    window.addEventListener('click', (e) => {
        if (e.target == addressModal) {
            addressModal.style.display = 'none';
            clearErrors();
            form.reset();
        }
    });

    // Form submission handler
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Perform all validations
        const isNameValid = nameValidationChecking();
        const isCityValid = cityValidationChecking();
        const isLandMarkValid = landMarkValidationChecking();
        const isStateValid = stateValidationChecking();
        const isPincodeValid = pincodeValidationChecking();
        const isPhoneValid = phoneValidationChecking();
        const isAltPhoneValid = altPhoneValidationChecking();

        // If all validations pass, proceed with form submission
        if (isNameValid && isCityValid && isLandMarkValid && isStateValid && 
            isPincodeValid && isPhoneValid && isAltPhoneValid) {
            
            // Collect form data
            const formData = {
                addressType: document.getElementById("addressType").value,
                name: document.getElementById("name").value,
                city: document.getElementById("city").value,
                landMark: document.getElementById("landMark").value,
                state: document.getElementById("state").value,
                pincode: document.getElementById("pincode").value,
                phone: document.getElementById("phone").value,
                altPhone: document.getElementById("altPhone").value
            };

            // Submit form via AJAX
            submitAddress(formData);
        }
    });
});

// Clear all error messages
function clearErrors() {
    const errorElements = document.querySelectorAll('.error-message');
    errorElements.forEach(element => {
        element.style.display = 'none';
        element.innerHTML = '';
    });
}

// Validation functions - now return boolean values
function nameValidationChecking() {
    const nameval = document.getElementById("name").value;
    const namepattern = /^[A-Za-z\s]+$/;
    const error1 = document.getElementById("error1");

    if(nameval.trim() === "") {
        error1.style.display = "block";
        error1.innerHTML = "Please enter a valid name";
        return false;
    } else if (!namepattern.test(nameval)) {
        error1.style.display = "block";
        error1.innerHTML = "Name can only contain alphabets and spaces";
        return false;
    } else {
        error1.style.display = "none";
        return true;
    }
}

function cityValidationChecking() {
    const cityval = document.getElementById("city").value;
    const citypattern = /^[A-Za-z\s]+$/;
    const error2 = document.getElementById("error2");

    if(cityval.trim() === "") {
        error2.style.display = "block";
        error2.innerHTML = "Please enter a valid city";
        return false;
    } else if (!citypattern.test(cityval)) {
        error2.style.display = "block";
        error2.innerHTML = "City can only contain alphabets and spaces";
        return false;
    } else {
        error2.style.display = "none";
        return true;
    }
}

function landMarkValidationChecking() {
    const landMarkval = document.getElementById("landMark").value;
    const landMarkpattern = /^[A-Za-z0-9\s]+$/;
    const error3 = document.getElementById("error3");

    if(landMarkval.trim() !== "" && !landMarkpattern.test(landMarkval)) {
        error3.style.display = "block";
        error3.innerHTML = "Landmark can only contain letters, numbers, and spaces";
        return false;
    } else {
        error3.style.display = "none";
        return true;
    }
}

function stateValidationChecking() {
    const stateval = document.getElementById("state").value;
    const statepattern = /^[A-Za-z\s]+$/;
    const error4 = document.getElementById("error4");

    if(stateval.trim() === "") {
        error4.style.display = "block";
        error4.innerHTML = "Please enter a valid state";
        return false;
    } else if (!statepattern.test(stateval)) {
        error4.style.display = "block";
        error4.innerHTML = "State can only contain alphabets and spaces";
        return false;
    } else {
        error4.style.display = "none";
        return true;
    }
}

function pincodeValidationChecking() {
    const pincodeval = document.getElementById("pincode").value;
    const pincodepattern = /^\d{5,6}$/;
    const error5 = document.getElementById("error5");

    if (pincodeval.trim() === "") {
        error5.style.display = "block";
        error5.innerHTML = "Please enter a valid pincode";
        return false;
    } else if (!pincodepattern.test(pincodeval)) {
        error5.style.display = "block";
        error5.innerHTML = "Pincode must be 5 or 6 digits";
        return false;
    } else {
        error5.style.display = "none";
        return true;
    }
}

function phoneValidationChecking() {
    const phoneval = document.getElementById("phone").value;
    const phonepattern = /^\d{10}$/;
    const error6 = document.getElementById("error6");

    if (phoneval.trim() === "") {
        error6.style.display = "block";
        error6.innerHTML = "Please enter a valid phone number";
        return false;
    } else if (!phonepattern.test(phoneval)) {
        error6.style.display = "block";
        error6.innerHTML = "Phone number must be 10 digits";
        return false;
    } else {
        error6.style.display = "none";
        return true;
    }
}

function altPhoneValidationChecking() {
    const altPhoneval = document.getElementById("altPhone").value;
    const phonepattern = /^\d{10}$/;
    const error7 = document.getElementById("error7");

    if(altPhoneval.trim() !== "" && !phonepattern.test(altPhoneval)) {
        error7.style.display = "block";
        error7.innerHTML = "Alternative phone number must be 10 digits";
        return false;
    } else {
        error7.style.display = "none";
        return true;
    }
}

// AJAX submission function
function submitAddress(formData) {
    $.ajax({
        url: "/addAddress",
        type: "POST",
        data: JSON.stringify(formData),
        contentType: "application/json",
        success: function(res) {
            if (res.success) {
                Swal.fire({
                    icon: "success",
                    title: "Success",
                    text: "Address added successfully",
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: res.message || "Failed to add address",
                });
            }
        },
        error: function(xhr, status, error) {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Failed to add address. Please try again.",
            });
            console.error("AJAX Error:", status, error);
        }
    });
}
    </script>
